#!/bin/bash

cd /bogo/gping

# note: ./www is sym linked to /var/www/html/gping (aka http://syswatch.science.mq.edu.au/gping/)

WEB=www
INCLUDE=$WEB/include.html
TIMESTAMP=$WEB/timestamp.html

source ~bogo/conda-setup.sh
conda activate gping
cat vmware-addresses |			# from PowerCLI (sitea, syd01m, syd04)
sed '
  /^10\.10\.100\.6/	s/^/-/		# firewall logs
  /^10\.10\.100\.7/	s/^/-/
  /^10\.10\.100\.26/	s/^/-/
  /^10\.10\.100\.129/	s/^/-/
  /^10\.111\./		s/^/-/		# survivor
  /^10\.123\./		s/^/-/		# survivor
  /^10\.138\./		s/^/-/		# HXC
  /^10\.63\./		s/^/-/		# SYD04 management VMs
  /^169\./		s/^/-/		# Network appliance VMs
  /^172\./		s/^/-/		# Private addresses
  /^192\./		s/^/-/		# Private addresses
  /^198\./		s/^/-/		# Network appliance VMs
  /pbx/ 		s/^/-/		# PABX Appliances - never pingable ...
  /MQU-MODE2/ 		s/^/-/		# SYD01 NSX appliances
  /MQUSYD01-DLR/        s/^/-/		# SYD01 NSX appliances
  /mc-nac/		s/^/-/		# Extreme Networks applicances
  /xmc-purview/		s/^/-/
  /dcaasprd2002a/	s/^/-/		# Snowflake
  /dcaasuat2002/	s/^/-/
' |
python gping.py |
sort -n |
awk -F, '
  BEGIN { colour["True"]="green"; colour["False"] = "red"; colour["Skipped"] = "grey" } 
        { print "<div id=\"" $1 "," $3 "," $4 "\" class=\"indicator " colour[$2] "\"><span class=\"tooltiptext\">" $1 "<br>" $3 "<br>" $4"</span></div>"}
' > $INCLUDE.tmp
chmod a+r $INCLUDE.tmp
mv $INCLUDE.tmp

date > $TIMESTAMP
